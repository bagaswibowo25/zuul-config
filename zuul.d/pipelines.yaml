- pipeline:
    name: check
    description: |
      Newly uploaded patchsets enter this pipeline to receive an
      initial +/-1 Verified vote.      
    manager: independent
    require:
      gerrit:
        open: True
        current-patchset: True
    trigger:
      zuullab:
        # Run this pipeline on new/changed pull requests
        - event: pull_request
          action:
            - opened
            - changed
            - reopened
        # Run in response to a pull request comment "recheck"
        - event: pull_request
          action: comment
          comment: (?i)^\s*recheck\s*$
        # When using the checks API to report results, failed runs
        # will have a "re-run" button which emits this event.
        - event: check_run
          action: rerequested
          check: .*/check:.*        
      gerrit:
        - event: patchset-created
        - event: change-restored
        - event: comment-added
          comment: (?i)^(Patch Set [0-9]+:)?( [\w\\+-]*)*(\n\n)?\s*recheck
    success:
      zuullab:
        check: 'success'
        comment: false
      gerrit:
        Verified: 1
    failure:
      zuullab:
        check: 'failure'
        comment: false
      gerrit:
        Verified: -1

- pipeline:
    name: gate
    description: |
      Changes that have been approved are enqueued in order in this
      pipeline, and if they pass tests, will be merged.      
    manager: dependent
    post-review: True
    require:
      zuullab:
        review:
          # Require an approval from user with write access (e.g. core-reviewer)
          - permission: write
            type: approved
        # Require label
        label: gate
        open: True
        current-patchset: True
      gerrit:
        open: True
        current-patchset: True
        approval:
          - Workflow: 1
    trigger:
      zuullab:
        - event: pull_request_review
          action: submitted
          state: approved
        - event: pull_request
          action: comment
          comment: (?i)^\s*regate\s*$
        - event: pull_request_review
          action: dismissed
          state: request_changes
        - event: pull_request
          action: status
          status: ".*:success"
        - event: check_run
          action: rerequested
          check: .*/gate:.*
        - event: pull_request
          action: labeled
          label:
            - gate
      gerrit:
        - event: comment-added
          approval:
            - Workflow: 1
    start:
      zuullab:
        check: 'in_progress'
        comment: false
      gerrit:
        Verified: 0
    success:
      zuullab:
        check: 'success'
        comment: false
      gerrit:
        Verified: 2
        submit: true
    failure:
      zuullab:
        check: 'failure'
        #status: 'failure'
        comment: false
      gerrit:
        Verified: -2